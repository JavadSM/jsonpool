<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <link rel="stylesheet" type="text/css" href="css/jsoneditor.css"/>
    <!--- use jquery for javascript and the jsoneditor plugin for the editor -->
    <script src="js/jquery.min.js"></script>
    <script src="js/jquery.jsoneditor.js"></script>
    <script src="js/pools.js"></script>
    <!-- Use a JSON only version of highligth.js -->
    <link rel="stylesheet" type="text/css" href="css/github.css">
    <script src="js/highlight.pack.js"></script>


    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>JSONPOOL</title>
    <!-- Json editor controller -->
    <script>
        let data = {}; // global data value

        function load(json = {}) {
            $('#editor').jsonEditor(json, {
                change: function(jsondata) {
                    data = jsondata;
                }
            }); 
        }

        function postit() {
            var input1 = document.getElementById("input1").value; var input2 = document.getElementById("input2").value;

            // if the push button says create but since we're updating
            // the pool, then we will change it to update
            if (document.getElementById("push").innerText === "create") {
                $('input:checkbox').attr('disabled', true); // disable checkbox
                document.getElementById("push").innerText = "update";
            }
            
            // callback function for selecting the auth and id
            function callback(data) {
                if (data.hasOwnProperty("id") && data.hasOwnProperty("auth")) {
                    $("#del").show();
                    document.getElementById("input1").value = data.id;
                    document.getElementById("input2").value = data.auth;
                }
                // place the highligted html in the response box
                document.getElementById("response").innerHTML = hljs.highlightAuto(JSON.stringify(data)).value;
            }
            
            if (input1 && input2) {
                // if the id and authkey is specified
                // then update the pool (override by default)
                update_pool(input1, input2, data, callback);
            } else {
                // if it's the first time were using the postit() function
                // then create a new pool
                create_pool(data, callback, $("#private").is(":checked"));
                reload() // load corrected data
            }
        }

        function rmpost() {
            var input1 = document.getElementById("input1").value;
            var input2 = document.getElementById("input2").value;
            
            function callback(data) {
                load({});
                document.getElementById("response").innerHTML = hljs.highlightAuto(JSON.stringify(data)).value;
                document.getElementById("input1").value = "";
                document.getElementById("input2").value = "";
                $("#del").hide();

                
                // if the push button says update but since we're deleting
                // the pool, then we will change it bask to create
                if (document.getElementById("push").innerText === "update") {
                    // reset checkbox
                    $('input:checkbox').removeAttr('checked');
                    $('input:checkbox').attr('disabled', false);
                    // rename button
                    document.getElementById("push").innerText = "create";
                }
            }

            if (input1, input2) {
                delete_pool(input1, input2, callback);
            }
        }
        
        function raw() {
            var input1 = document.getElementById("input1").value;
            if (input1) window.open("/pool/" + input1);
        }

        function reload() {
            var input1 = document.getElementById("input1").value;
            var input2 = document.getElementById("input2").value;

            if (input2) {
                $('#del').show();
            }

            function callback(data) {
                if (typeof data === "object") {
                    load(data)
                }
            }
            // get pool from server
            get_pool(input1, callback, input2);
        }

    </script>   
</head>
<body onload="hljs.configure({useBR: true}); $('#del').hide(); load();">
    <h1>JSONPOOL: Secure json storage</h1>
    <br>
    <input class="input" id="input1" placeholder="id"></input>
    <input class="input" id="input2" placeholder="auth"></input>
    <button class="ok-btn" onclick="reload()">load</button>
    <br>
    <br>
    <div class="box">
        <div id="editor" class="json-editor"></div>
    </div>
    <br>
    <button class="ok-btn" onclick="postit()" id="push">create</button>
    <button class="rm-btn" onclick="rmpost()" id="del">delete</button>
    <input type="checkbox" id="private">Private</input>

    <pre><code id="response"></code></pre>
    <br>
    <a onclick="raw()" class="link">View raw</a>
    <a>&nbsp;&nbsp;</a>
    <a onclick="window.location.replace('about.html')" class="link">Read More</a>
</body>
</html>